{% extends 'base.html' %}

{% block head %}
  {{ super() }}
  <!-- 引入 ECharts 文件 -->
  <script src="https://cdn.bootcss.com/echarts/4.4.0-rc.1/echarts.min.js"></script>
  <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>

{% endblock head %}

{% block content %}
  
  <!-- Navigation -->
  <nav class="navbar navbar-light bg-light static-top">
    <div class="container">
      <a class="navbar-brand" href="#">
        {% if current_user.is_authenticated %}
        {{current_user.username}}
        {% else %}
        StudyAssistant
        {% endif %}
      </a>
      <div class="float-right col-6">
        <!--<div class="col-lg-6">-->
        <form method="post" class="form-horizontal">
          <div class="input-group">
            <input type="text" class="form-control" name="keywords" placeholder="Search for...">
            <span class="input-group-btn">
              <button class="btn btn-primary" type="submit">Go!</button>
            </span>
          </div>
        </form>
        <!--</div>-->
      </div>
      <a class="btn btn-primary" href="{{url_for('signout')}}">Log Out</a>
    </div>
  </nav>

  <!-- Testimonials -->
  <section class="testimonials bg-light">
    <div class="container">
        <h3> Results: </h3><br>
        {% for concept in concepts %}
        <h2 class="mb-5">{{ concept["_source"]["concept"]|replace("_", " ") }}</h2>
        <p>{{ concept["_source"]["definition"] }}</p><br>
        {% endfor %}
      <br>
      <h2 class="mb-5">相关概念</h2>
    
      <p>RELATIONS:</p>
      <p>{{relations}}</p>
      <p>BBB:</p>
      <p>{{bbb}}</p>
  {% if relations|length != 0 %} {# 搜索出来相关节点和关系的话，展示关系图 #}
  <!-- 为 ECharts 准备一个具备大小（宽高）的 DOM -->
  <div style="margin: 0 auto; border: 1px solid #ccc; padding-top: 30px;">
    <div id="main" style="width: 90%;height:30%;"></div>
    <script type="text/javascript">
      var entityRelation = jQuery.parseJSON({{ relations|tojson|safe }});   
        //console.log(entityRelation);

        var maxDisPlayNode = 25;
        var data = [];  // echarts中的节点数组
        var links = [];  // echarts中边的数组
        var node = {} ;
        var t = 1;
        var data2 = [];
        var id = 0;

        var key_word = "{{ textforsearch }}";  
        console.log(key_word); 
        node['name'] = key_word;
        node['category'] = 0;
        node['draggable'] = true;  // 设置中心节点是否可以拖拽
        node['id'] = id.toString();
        data.push(node);

        // 获取实体2, 存储在data中, 如果实体2已经存在于data中, 则不push
          // 对展示节点的数量进行限制
        // console.log("实体长度----->", entityRelation.length);  // 显示关系个数
        for(var i = 0; i < Math.min(maxDisPlayNode, entityRelation.length); i++) {

            var node1 = {};
            var node2 = {};

            if(((entityRelation[i]||{}).r||{}).name == 'RelatedTo') {
                if(entityRelation[i]['n']['name'] == key_word){
                    node2['category'] = 1;
                } else {
                    node1['category'] = 1;
                }
                  
            } else if (((entityRelation[i]||{}).r||{}).name== 'IsA') {
                if(entityRelation[i]['n']['name'] == key_word){
                    node2['category'] = 2;
                } else {
                    node1['category'] = 2;
                }
            } else if (((entityRelation[i]||{}).r||{}).name == 'Prerequisite') {
                if(entityRelation[i]['n']['name']  == key_word){
                    node2['category'] = 3;
                } else {
                    node1['category'] = 3;
                }
            } else if (((entityRelation[i]||{}).r||{}).name== 'SubclassOf') {
                if(entityRelation[i]['n']['name']  == key_word){
                    node2['category'] = 4;
                } else {
                    node1['category'] = 4;
                }
            } else  {
                node2['category'] = 5;
                node1['category'] = 5;
            }

            node1["name"] = ((entityRelation[i]||{}).n||{}).name;
            node1["draggable"] = true;
            id = i + 1;
            var flag = 1;
            t = 1;
            relationTarget = id.toString();
            
            for (var j = 0; j < data.length; j++) {
                if (data[j]["name"] === node1["name"]) {
                    flag = 0;
                    t = 0;
                    relationTarget = data[j]["id"];
                    break;
                }
            }
            node1["id"] = relationTarget;
            node1["symbolSize"] = 20;

            node2["name"] = ((entityRelation[i]||{}).m||{}).name;
            node2["draggable"] = true;

            flag = 1;
            relationTarget = id.toString();
            for (var j = 0; j< data.length; j++){
                if (data[j]["name"] === node2["name"]){
                    flag = 0;
                    relationTarget = data[j]["id"];
                    break;
                }
            }

            node2["id"] = relationTarget;
            node2["symbolSize"] = 20;

            relation = {};
            relation["target"] = node2["id"];  // 关系指向的终点, 也是id, 即通过节点的id描述两个节点以及关系
            relation["category"] = 0;
            relation["source"] = node1["id"];
            relation["value"] = ((entityRelation[i]||{}).r||{}).name;
            relation["symbolSize"] = 20;
            links.push(relation);

            if (flag === 1 ) { //node2相同
                data.push(node2);
            }
            else if (t == 1){ //node1相同
                data.push(node1);
            }
            else {
                maxDisPlayNode += 1;
                for (var k = 0; k < links.length; k++) {
                    
                    if (links[k]["target"] === relation["target"] &&links[k]["source"] === relation["source"] ) {
                        relation["symbolSize"] = 20;
                        links[k]["value"] = ((entityRelation[i]||{}).r||{}).name;
                        break;
                    }
                }
            }
        }
        // console.log("data====>>>", data);
        // console.log("links====>>>", links);

        // 初始化echarts实例
        var myChart = echarts.init(document.getElementById("main"));

        option = {
            title: {
                center: ['55%', '60%'],
                text: "Relation of "+ key_word,
                x:'center',//水平安放位置，默认为'left'，可选为：'center' | 'left' | 'right' | {number}（x坐标，单位px）
                y: 'top',//垂直安放位置，默认为top，可选为：'top' | 'bottom' | 'center' | {number}（y坐标，单位px）
                padding : 25,//边距
                textStyle: {//主标题文本样式{"fontSize": 18,"fontWeight": "bolder","color": "#333"}
                fontSize: 24,
                fontStyle: 'normal',
                fontWeight: 'normal',
                color : "black",
                },
            },
            tooltip: {},
            animationDurationUpdate: 1500,
            animationEasingUpdate: "quinticInOut",
            label: {
                normal: {
                    show: true,
                    textStyle: {
                        fontSize: 12
                    },
                }
            },
            legend: {
                //x: "center",
                orient: 'vertical',
                left : "auto",
                top: "90%",//修改距顶部的距离可调至两列
                //padding:[780,0,0,1100],   //可设定图例[距上方距离，距右方距离，距下方距离，距左方距离]
            },
            series: [

                {
                    center: ['55%', '60%'],
                    type: "graph",
                    layout: "force",
                    symbolSize: 30, // 全局默认大小(中心节点)
                    focusNodeAdjacency: true,  // 是否在鼠标移到节点上的时候突出显示节点以及节点的边和邻接节点, 默认是true
                    hoverAnimation : true,//是否开启鼠标悬停节点的显示动画
                    roam: true,
                    edgeSymbol: ['none', 'pin'], //symbol:'roundRect',//关系图节点标记的图形。ECharts 提供的标记类型包括 'circle'(圆形), 'rect'（矩形）, 'roundRect'（圆角矩形）, 'triangle'（三角形）, 'diamond'（菱形）, 'pin'（大头针）, 'arrow'（箭头）
                    edgeSymbolSize: [2, 2],
                    
                    label: {
                        normal: {
                            show: true,
                            textStyle: {
                                fontSize: 12,
                                fontStyle : "normal",
                                fontWeight : "bolder",
                                fontFamily : "sans-serif",
                            },
                        }
                    },
                    force: {
                        repulsion: 1000,
                        edgeLength: [150, 100],
                        layoutAnimation : true,
                        // 因为力引导布局会在多次迭代后才会稳定, 这个参数决定是否显示布局的迭代动画(节点数量过多, 图在迭代的过程中会旋转),
                        // 在浏览器端节点数据较多(>100)的时候不建议关闭, 布局过程会造成浏览器假死。
                    },
                    
                    edgeLabel: {
                        normal: {
                            show: true,
                            textStyle: {
                                fontSize: 11 
                            },
                            formatter: "{c}"   // 标签内容格式器。模板变量有 {a}、{b}、{c}，分别表示系列名，数据名，数据值。
                        }
                    },

                    categories: [{  // 结点颜色
                        name: 'key_word',
                        itemStyle: {
                            normal: {
                                color: "#B23AEE",//0;
                            }
                        }
                    },{
                        name: 'RelatedTo',
                        itemStyle: {
                            normal: {
                                color: "#00DDDD",//1
                            }
                        }
                    }, {
                        name: 'IsA',
                        itemStyle: {
                            normal: {
                                color:"#E829E8",//2
                            }
                        }
                    },{
                        name: 'Prerequisite',
                        itemStyle: {
                            normal: {
                                color: "#4592FF",//3
                            }
                        }
                    },{
                        name: 'SubclassOf',
                        itemStyle: {
                            normal: {
                                color: "#F08080",//4
                            }
                        }
                    },  {
                        name: 'Other',
                        itemStyle: {
                            normal: {
                                color: "#746E59",//5
                            }
                        }
                    }],


                    data: data,  // 节点
                    links: links,  // 边或者关系
                    lineStyle: {
                        normal: {
                            opacity: 0.5,
                            width: 1.0,
                            curveness: 0,
                            color: "000000" /// 线的顏色 需要改
                        }
                    }
                }
            ]
        };
        myChart.setOption(option);  // 这步很重要, 必须设置才可以有效
        myChart.on("mouseup", function (param){
            console.log("param---->", param);  // 打印出param, 可以看到里边有很多参数可以使用
            //获取节点点击的数组序号
            var arrayIndex = param.dataIndex;
            console.log("arrayIndex---->", arrayIndex);
            console.log("name---->", param.name);
            var option = myChart.getOption();
            option.series[0].node[params.dataIndex].fixed=true;
            myChart.setOption(option);
        });
   
    </script>
  </div>
  {% endif %}
  <br>

  <h2 class="mb-5">推荐学习路径</h2>
  {% if prereqs["_source"]|length != 0 %}
    <p>{{prereqs["_source"]}}</p>
    <br>
    <p>a graph:</p>
    <div id="container" style="height: 800px; margin: 0 auto; border: 1px solid #ccc; padding-top: 30px;"></div>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts-stat/dist/ecStat.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts/dist/extension/dataTool.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts/dist/extension/bmap.min.js"></script>
    <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js" ></script>
    <script type="text/javascript">
         var dom = document.getElementById("container");
         var myChart = echarts.init(dom);
         var app = {};
         option = null;

         var option = {
            title: {
                center: ['55%', '60%'],
                text: "Advanced Courses of "+ key_word,
                x:'center',//水平安放位置，默认为'left'，可选为：'center' | 'left' | 'right' | {number}（x坐标，单位px）
                y: 'top',//垂直安放位置，默认为top，可选为：'top' | 'bottom' | 'center' | {number}（y坐标，单位px）
                padding : 25,//边距
                textStyle: {//主标题文本样式{"fontSize": 18,"fontWeight": "bolder","color": "#333"}
                fontSize: 24,
                fontStyle: 'normal',
                fontWeight: 'normal',
                color : "black",
                },
             },
             tooltip: {
                 trigger: 'item',
                 triggerOn: 'mousemove'
             },
             series:[
                 {
                     center: ['55%', '60%'],
                     type: 'tree',
                     id: 0,
                     name: 'tree1',
                     data: [],
                     edgeSymbol: ['none', 'arrow'],


                     top: '10%',
                     left: '15%',
                     bottom: '22%',
                     right: '10%',

                     symbolSize: 7,

                     edgeShape: 'polyline',
                     edgeForkPosition: '63%',
                     initialTreeDepth: 3,

                     lineStyle: {
                         width: 1.0,
                     
                         color: "#262626"
              
                     },

                     label: {
                         backgroundColor: 'azure',
                         position: 'left',
                         verticalAlign: 'middle',
                         align: 'right'
                     },

                     leaves: {
                         label: {
                             position: 'right',
                             verticalAlign: 'middle',
                             align: 'left'
                         }
                     },
                     roam: true,
                     expandAndCollapse: true,
                     animationDuration: 550,
                     animationDurationUpdate: 750
                 }
             ]
         }
     
         if (option && typeof option === "object") {
             myChart.setOption(option, true);
         }
         console.log("dda");
     $.get('http://localhost:5000/static/data.json').done(function (data) {//此处是json文件的路径
         console.log(data);
         myChart.setOption({
             series: [{
         // 根据名字对应到相应的系列
             name: 'tree1',
             data: data
             }]
         });
     });
    </script>
    <br>
    <a>These courses are from MIT,click</a>
    <a href="https://ocw.mit.edu/courses/mit-curriculum-guide/" target="_blank">  here</a>
    <a> to learn more about them!</a>
  {% else %}
    <p>暂时没有推荐的学习路径，请修改查询词后重新尝试</p>
  {% endif %}

  <h2 class="mb-5">资源合集</h2>
  <div>
    <!--Nav tabs-->
    <ul class="nav nav-tabs" role="tablist">
      <li role="presentation" class="active"><a href="#books" aria-controls="home" role="tab" data-toggle="tab">   Books   </a></li>
      <li role="presentation"><a href="#courses" role="tab" aria-controls="courses" data-toggle="tab">   Courses   </a></li>
      <li role="presentation"><a href="#papers" role="tab" aria-controls="papers" data-toggle="tab">   Papers   </a></li>
      <li role="presentation"><a href="#moocs" role="tab" aria-controls="moocs" data-toggle="tab">   MOOCs   </a></li>
    </ul>
    
    <!--Tab panes-->
    <div class="tab-content">
      <div role="tabpanel" class="tab-pane active" id="books">
        <ol>
          <li><a href="https://github.com//loveunk/Deep-learning-books/blob/master/1.%20Machine%20Leaning%20and%20Deep%20Learning/A%20First%20Course%20in%20Machine%20Learning-2012.pdf">A First Course in Machine Learning-2012.pdf</a></li>
          <li><a href="https://github.com//loveunk/Deep-learning-books/blob/master/1.%20Machine%20Leaning%20and%20Deep%20Learning/AutoML%20Machine%20Learning-Methods%2C%20Systems%2C%20Challenges-2018.pdf">AutoML Machine Learning-Methods, Systems, Challenges-2018.pdf</a></li>
          <li><a href="https://github.com//loveunk/Deep-learning-books/blob/master/1.%20Machine%20Leaning%20and%20Deep%20Learning/Building%20Machine%20Learning%20Systems%20with%20Python-2nd%20Edition-2015.pdf">Building Machine Learning Systems with Python-2nd Edition-2015.pdf</a></li>
          <li><a href="https://github.com//loveunk/Deep-learning-books/blob/master/1.%20Machine%20Leaning%20and%20Deep%20Learning/Data%20Mining%2C%20Inference%2C%20and%20Prediction-2017.pdf">Data Mining, Inference, and Prediction-2017.pdf</a></li>
          <li><a href="https://github.com//loveunk/Deep-learning-books/blob/master/1.%20Machine%20Leaning%20and%20Deep%20Learning/Data%20Science%20from%20Scratch-%20First%20Principles%20with%20Python-2015.pdf">Data Science from Scratch- First Principles with Python-2015.pdf</a></li>
          <li><a href="https://github.com//loveunk/Deep-learning-books/blob/master/1.%20Machine%20Leaning%20and%20Deep%20Learning/Deep%20Learning%20with%20Keras-2017.pdf">Deep Learning with Keras-2017.pdf</a></li>
          <li><a href="https://github.com//loveunk/Deep-learning-books/blob/master/1.%20Machine%20Leaning%20and%20Deep%20Learning/Deep%20Learning%20with%20Python%20A%20Hands-on%20Introduction-2017.pdf">Deep Learning with Python A Hands-on Introduction-2017.pdf</a></li>
          <li><a href="https://github.com//loveunk/Deep-learning-books/blob/master/1.%20Machine%20Leaning%20and%20Deep%20Learning/Deep%20Learning%20With%20Python-Develop%20Deep%20Learning%20Models%20on%20Theano%20and%20TensorFlow%20Using%20Keras-2017.pdf">Deep Learning With Python-Develop Deep Learning Models on Theano and TensorFlow Using Keras-2017.pdf</a></li>
          <li><a href="https://github.com//loveunk/Deep-learning-books/blob/master/1.%20Machine%20Leaning%20and%20Deep%20Learning/Deep%20Learning%20with%20Python-Francois_Chollet-En-2018.pdf">Deep Learning with Python-Francois_Chollet-En-2018.pdf</a></li>
          <li><a href="https://github.com//loveunk/Deep-learning-books/blob/master/1.%20Machine%20Leaning%20and%20Deep%20Learning/Deep%20Learning%20with%20Python-Francois_Chollet-%E4%B8%AD%E6%96%87-Python%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0-2018.pdf">Deep Learning with Python-Francois_Chollet-中文-Python深度学习-2018.pdf</a></li>
        </ol>
      </div>
      <div role="tabpanel" class="tab-pane" id="courses">
        courses...
      </div>
      <div role="tabpanel" class="tab-pane" id="papers">
        papers...
      </div>
      <div role="tabpanel" class="tab-pane" id="moocs">
        moocs...
        <p>{{moocs}}</p>
        <p>Here are some mooc resources recommended for you:</p>
        {% if moocs|length != 0 %}
        <ol>
          {% for mooc in moocs %}
          <li>
            <strong>{{ mooc["_source"]["name"] }}</strong>
            <p>
              {% if mooc["_source"]["platform"] != "" %}
              Platform: {{ mooc["_source"]["platform"] }},      
              {% endif %}
              {% if mooc["_source"]["school"] != "" %}
              School: {{ mooc["_source"]["school"] }}
              {% endif %}
            </p>
            <!--{% if mooc["_source"]["blackboard"] != "" %}
            <p>Mooc description: {{ mooc["_source"]["blackboard"]|safe }}</p>
            {% endif %}-->
          </li>
          {% endfor %}
        </ol>
        {% endif %}
      </div>
    </div>
  </div>
    


  </div>
  </section>

{% endblock content %}
