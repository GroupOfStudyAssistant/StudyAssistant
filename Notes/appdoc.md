# 网站开发文档(与使用文档)

应用程序以网站的形式构建, 主要界面的设计图如下:

<img src="appdoc.assets/view.jpg" alt="view" style="zoom: 25%;" />

## 整体思路

1.网页展示(不用微信小程序+去掉个性化生成的对话...原因)
2.用户搜索概念，返回:
- 概念的解释
- IsA, RelatedTo, Prerequisites等关系图+概念先修关系图【概念的学习路径】
- 相关课程的先修关系图【课程的学习路径】
- 资源推荐：所有相关大学课程、慕课、（书籍、论文）


### 需求分析

1. 用户登录功能需要实现注册登录和注销的功能(感觉这个功能比较鸡肋).

2. 搜索功能接收的输入是某个概念, 这个概念可以是一些比较具体的知识点, 也可以是一个比较宽泛的领域. 结果包括很多方面: 
   + 对这一概念的简短解释.(类似百科?) 
   + 利用图数据库生成概念的网状图, 联系与该概念有关的其他概念结点, 该图可以添加动态效果, 比如区分中心结点和周围结点, 各结点的点击效果, 据此对概念解释进行的更改...
     一个多层的图，分层展示和此知识点相关的上层概念、下层概念、所属课程、所属书籍、相关信息等。
     点击图中任何一个结点，则该结点变成中心结点，知识点解释中的文字也对应新中心结点的解释。
   + 与该概念有关的资源列表, 比如论文和书籍(这一功能需要数据支持,暂时**不具备条件**), 只有部分数据, 界面需要使用tab标签来布局. 
   + 如果搜索的概念命中了某个课程, 或者与课程有很强的关系. 可以展示课程数据库中的课程介绍和课程的先修关系. 课程**内部**的学习方案生成需要数据支持, 暂时**没有解决方案**?

3. 概念解释应该按照精确度排序, 确保最匹配的结果在第一个.
4. 概念的网状图中的先修关系单独提取出来形成概念的先修图.
5. 课程先修关系可以使用桑基图或树图展示.





## 设计与实现

### 概述

+ 数据内容范围限于计算机科学领域.
+ 使用python中的flask框架实现网站架构. 
+ 搜索功能使用ElasticSearch实现.
+ 数据库使用开源的MySQL支持.
+ 图数据库使用neo4j.
+ dbpedia-spotlight用于从文本中提取概念



### 网站设计

#### 路由结构

该表格需要维护.

| 路由     | 主要功能                                                     |
| -------- | ------------------------------------------------------------ |
| /        | 欢迎界面,提供注册和登录的链接.                               |
| /signup  | 注册界面, 提供注册功能,将用户的注册信息添加到数据库. 注册成功后重定向到"/welcome"路由. |
| /signin  | 登录界面, 提供登录功能, 验证用户输入, 验证成功后重定向到"/welcome"路由. |
| /welcome | 登录后的界面, 进行内容的展示.(可以考虑与首页合并, 设计不同的视图.) 提供登出选项, 重定向到"/" |

+ welcome路由下可以

未登录用户:
不能进入welcome界面(welcome路由)
不能登出(进入signout路由)
登录用户:
不能进入index路由(暂时)
不能登录.

待维护.



#### 前端界面

20200211待完善:

1. 标签页的样式（感觉是和landingpage的样式有冲突）
2. 关闭网页时自动logout（否则再次打开无signin signup按钮，只有最下方有welcome按钮），需要修改
3. 注册/登录成功后消息flash在页面顶部，刷新才会消失
4. welcome页面的搜索框是否需要加`<form method="post">`？



### 数据/资源

#### 王老师提供的资源

20200226:
老师提供的数据库包括8个表：
可用：

1. concept: concept和definition，均为text， 3810000+条，但只有少数与计算机相关
2. entity: EntityName和Wiki(其维基百科链指)，153个实体，大概一半跟计算机有关，待探索用法
3. mooc: name, chinesename, duration, platform, school, department
    1988条数据，其中200为计算机领域课程，中英文都有，url全不可用

不可用：
1. user: 师姐项目的user
2. userentity: EntityName和Master，意义不明
3. entityvideo: VID, EName, time，不可用（师姐遗留）
4. uservideo: VID, lastlearn(日期时间)
5. video: VID, VName, Course, Vurl，是Coursera上部分视频的记录，只涉及5门课内47个视频片段，大概是师姐遗留产物

(补充)

B站数据在哪里?(from 20200223)



#### 杨师兄提供的资源

杨师兄提供的图谱数据只有一个dump文件, 需要导入neo4j.

#### 小组收集的资源

mit ocw网站的map是否有相关API

+ 课程先修关系数据

  由小组通过爬虫获取, 目前包括: mit:16, uw:248, caltech:135, stanford:~90对关系. 



### 概念解释功能

将concept数据表通过ES构建索引, 作为概念解释功能的基础.
在webapp中, 主要工作是完成: 当用户请求查询时, 调用ES的搜索接口检索索引, 返回给用户, 或者, 根据索引中的内容到数据库中查询, 然后返回给用户.

初步实验仅使用concept表.

建立索引的过程是把数据库中的数据先用python读入, 再写到ES的结点上, 这一部分由樊完成. 疑问: 为什么不使用"如果条目存在就跳过插入"的命令.

20200310 实现查询知识点的功能.

待完善：(hwc: 是否已经完善?)(还没)

1. 查询的精细化：添加权重等
2. 普通数据库->ORM形式，这样才能比较优雅地“返回id，用id去数据库中查询，送至模板”。当前只是单纯返回全部数据。
3. 更好的数据展示方式，如何跳转，如何折叠+readmore展开

目前概念数据都**在ES中**, 没有使用关系型数据库作为辅助. 

爬取到的课程数据可以做为该功能数据的补充. 



### 资源推荐功能

根据需求分析, 需要在返回概念的查询结果时, 在页面下方放置一行标签栏, 每个标签对应一类资源. 其中一个标签是与概念有关的慕课资源(链接). 这一部分功能以王老师提供的数据库中的mooc表作为支撑. 也是**用ES实现**, 并且所有数据都存放在ES中. 

+ 20200314 实现查询相关慕课的功能

+ 20200313 粗略加了mooc查询部分



### 概念网状图功能

根据需求分析, 需要在查询概念时生成与该概念有关的概念一起组成的网状图, 这个功能使用知识图谱实现, 工具是**neo4j**. 杨师兄提供的图谱数据作为数据支撑, 但是这一部分的检索使用的是neo4j自身的检索功能, 没有使用ES.

(可能需要改进) 



### 先修关系功能

包括概念的先修关系和课程的先修关系. 

概念的先修关系是对检索的概念进行先修关系的分析并展示, 也是**用neo4j实现**, 使用图谱数据.

课程的先修关系是指在检索的概念与某个课程相关的时候, 将这个课程的先修关系展示出来. 使**用ES实现**? 使用的数据是小组爬取国外大学课程信息获得的. 

课程标题导入ES用于搜索?(from 20200421)



## 测试与运行

### 测试过程

20200223 测试1: 测试对象?

测试时同一个测试函数（针对同一个页面）内不会清空数据库，在测试该页面上不同的功能时可能需要手动退出之前的用户登录或者清空数据库

对assert的了解不够深入，不知道是否有更高效和精准的方法

目前的测试只有76%的覆盖率，还需提高

执行单元测试的方法：（出错则可看到出错信息）

```
(env) $ python test.py
...............
----------------------------------------------------------------------
Ran 15 tests in 2.942s

OK
```

查看测试覆盖率：

```
(env) $ pip install coverage
(env) $ coverage run --source=flaskweb test.py  (测试并汇报)
$ coverage report
Name     Stmts   Miss  Cover
----------------------------
xx.py     146      5    97%
```

20200224:
使用包组织程序，调整后项目文件结构如下：

```
├── .flaskenv
├── test.py            # 测试程序
└── flaskweb           # 程序包
    ├── __init__.py    # 包构造文件，创建程序实例和拓展对象，定义应用设置
    ├── commands.py    # 命令函数
    ├── models.py      # 模型类
    ├── views.py       # 视图函数
    ├── static
    │   ├── css
    │   │   ├──landing-page.css
    │   │   └──landing-page.min.css
    │   ├── img   
    │   │   └── ...(原模板自带图片7张)
    │   └── vendor
    │   │   └── ...(原模板自带样式和字体)
    └── templates
        ├── base.html
        ├── index.html
        ├── signin.html
        ├── signup.html
        └── welcome.html
```



### 运行方法

#### 环境配置

+ Flask

Flask的运行需要Python3, 所以最好在项目文件夹下建立相应虚拟环境, 安装flask模块, 不同平台有相应的配置办法. 在配置好flask后将源代码放入项目根目录, 就配置好了flask的调试环境. 

+ ES

概念解释功能用到了ES. 需要配置ES环境. Win10系统下有压缩包, 无需安装. 如果希望可视化使用ES, 需要安装kibana, 配置方法类似, 将会给出可访问的地址:端口号.

Linux下暂时没有了解. ES的数据默认位置在根目录下的data文件夹中, 迁移时可使用该文件夹. 配置文件在根目录config文件夹中.

ES数据的导入是用python脚本将MySQL中的数据取出并插入得到的.

+ neo4j

概念网状图功能用到了neo4j, 需要配置环境. Win10下有压缩包, 解压到需要的位置. 对于windows, 首次运行需要安装服务, 在bin目录下执行 `./neo4j.bat install-service`  即可.

neo4j作为一种服务存在, 服务如果不关闭, 会随系统启动而开启(如果使用powershell, 可以使用neo4j.psl文件):

```
./neo4j.bat start #开启服务
./neo4j.bat stop #关闭服务
./neo4j.bat console #打开控制台(该命令包含启动服务的功能)
#打开控制台后使用ctrl+c可以同时关闭控制台和服务.
./neo4j.bat status #查看运行状态
```

如果希望使用控制台, 应该在服务关闭的情况下执行**打开控制台的命令**, 命令将会提示可以用于访问的地址:端口号, 如果在服务开启时试图打开控制台, 将会由于端口占用或者文件锁定等原因失败.

neo4j的数据迁移最好使用本身提供的导入导出功能.
导入方法:
首先关闭服务, 然后使用命令

```
neo4j-admin.bat load --from=<path>/2016-10-02.dump --database=graph.db --force
```

重新开启服务即可.

导出方法:

```
neo4j-admin.bat  dump --database=graph.db --to=<path>/<dump文件>
```

+ 其他

配置mysql环境. Win10系统下可以使用安装包安装, 安装完成后可随时开启/关闭服务. Debian/RedHat暂时没有了解. (这个好像与运行无关?)数据库迁移使用导入导出功能.



#### 运行

1. 进入elasticsearch安装文件夹的bin目录，执行`./elasticsearch.bat`开启服务.
2. 进入neo4j安装文件夹的bin目录，执行`./neo4j.bat console` 开启服务.
3. 进入StudyAssistant文件夹，初次使用时先执行`flask initdb`初始化数据库，再`flask forge`生成虚拟数据，最后`flask run`运行；之后使用只需要执行`flask run`.



ES里的数据包括老师给的资源中的concept和mooc, 以及我们收集的course数据. 但这些数据有一个从关系型数据库到ES索引的过程, 所以如果无法直接从ES导出, 就需要用关系型数据库去再次处理.

neo4j是管理图数据库的工具, 本项目中只用到了师兄给的一个数据文件, 导入即可. neo4j不支持模糊的搜索, 只有查询功能, 所以属于精确匹配, 有待改进. 




## 使用手册

